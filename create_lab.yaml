---

- name: "Create Lab Environment"
  hosts: all
  remote_user: root

  tasks:
    - name: "Check for existing lab"
      stat: path=/root/.labconfig
      register: labrunning

    - name: "Spawn Lab"
      command: bash /root/rpcops-onmetal-labconfigurator/rpcops-lab-setup
      async: 3600
      poll: 0
      register: labcreated
      when: labrunning.stat.exists == False

    - name: "Wait for Lab creation"
      async_status: jid={{ labcreated.ansible_job_id }}
      register: labdone
      until: labdone.finished
      retries: 120
      delay: 10
      when: labcreated.ansible_job_id is defined

    - block:
      - name: "Prepare Cinder Storage"
        command: ansible-playbook -i inventory playbooks/cinder-disks-prepare.yml chdir=/root/rpcops-onmetal-labconfigurator

      - name: "Prepare Swift Storage"
        command: ansible-playbook -i inventory playbooks/swift-disks-prepare.yml chdir=/root/rpcops-onmetal-labconfigurator

      - name: "Prepare VMs for OpenStack-Ansible"
        command: ansible-playbook -i inventory playbooks/pre-openstack-install.yml chdir=/root/rpcops-onmetal-labconfigurator
      when: labdone.finished
